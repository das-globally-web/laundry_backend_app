{% load json_filters %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laundry Service</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/media/css/iroon.css" />
  <link rel="icon" href="/media/images/favicon-icons.png" type="image/x-icon" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Monoton&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@100..900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" />

  <style>
    .product-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }

    .product-name {
      flex: 2;
      font-weight: bold;
    }

    .quantity-controls {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    .quantity-controls button {
      width: 30px;
      height: 30px;
      border: none;
      background-color: #007bff;
      color: white;
      font-size: 18px;
      border-radius: 4px;
      cursor: pointer;
    }

    .quantity {
      width: 30px;
      text-align: center;
    }

    .product-price {
      flex: 1;
      text-align: right;
      font-weight: bold;
    }

    .total {
      margin-top: 20px;
      text-align: right;
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>

<body class="homehtml aboutus servicees price blog contact-one contact-true">
  <div class="main-project" id="lendding-pages">
    <header class="header satrtcode">
      <nav class="navbar navbar-expand-lg p-0">
        <div class="container dlidertogal">
          <a class="navbar-brand andkarsedr" href="/"><img src="/media/images/logo-project.svg" alt="ironissue" /></a>
          <div class="searctitle">
            <div class="d-flex frsgrtt form-topheadre" data-bs-toggle="modal" data-bs-target="#exampleModaledfr">
              <button class="btn" type="submit">Schedule a pickup</button>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="exampleModaledfr" tabindex="-1" aria-labelledby="exampleModaledfr"
              aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header modealsong">
                    <h5 class="modal-title">Schedule a Pickup</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div>
                      <p>Your Name*</p>
                      <input type="text" name="name" placeholder="Your Name*" required class="form-control my-2"
                        value="{{context.name}}">
                      <p>Phone*</p>
                      <input type="tel" name="phone" placeholder="Your Phone Number" required class="form-control"
                        value="{{context.phone}}">
                      <p>Address*</p>
                      <input type="text" name="address" placeholder="Address*" required class="form-control my-2"
                        value="{{context.address}}">
                      <p>Choose Product*</p>
                      <div id="product-list">
                        {% for pro in product %}
                        {% for item in pro.price_json %}
                        <div class="product-row" data-id="{{ pro.id }}" data-title="{{ pro.title }}"
                          data-service="{{ item|jsonify }}" data-price="{{ item.price }}">
                          <div class="product-name">{{ pro.title }}</div>
                          <div class="quantity-controls">
                            <button type="button" class="decrease">-</button>
                            <span class="quantity">0</span>
                            <button type="button" class="increase">+</button>
                          </div>
                          <div class="product-price">₹{{ item.price }}</div>
                        </div>
                        {% endfor %}
                        {% endfor %}
                      </div>
                      <div class="total">
                        Total: ₹<span id="total-price">0</span>
                      </div>
                      <label class="mt-3">Pickup Date</label>
                      <input type="date" name="pickup_date" id="pickupDate" class="form-control mb-2" required>
                      <label>Pickup Slot</label>
                      <select name="pickup_slot" id="pickupSlot" class="form-select mb-2" required>
                        <option value="">Select Pickup Slot</option>
                      </select>
                      <label>Drop Slot</label>
                      <select name="drop_slot" id="dropSlot" class="form-select mb-2" required>
                        <option value="">Select Drop Slot</option>
                      </select>
                      <input type="hidden" name="selected_items" id="selected-items">
                      <input type="hidden" id="userId" value="{{ context.id }}">
                      <button id="mysubmitbtn" class="btn btn-primary w-100 on">Order
                        Now</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <button class="navbar-toggler buttonsdee" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
              aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
          </div>
          <div class="collapse navbar-collapse navbar-expand-navs" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/service">Our Services</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/price">Prices</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/blog">Blog</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/contactus">Contact</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/aboutus">About us</a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link"><i class="fa-brands fa-instagram"></i></a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link"><i class="fa-brands fa-square-facebook"></i></a>
              </li>
            </ul>
            <div class="d-flex form-topheadre" role="search">
              {% if context.is_login %}
              <button class="btn" type="submit" data-bs-toggle="modal" data-bs-target="#exampleModal">Schedule a
                pickup</button>
              {% else %}
              <div class="form-login">
                <a href="/login"><i class="fa-solid fa-user"></i> Log In</a>
              </div>
              {% endif %}

              <!-- Modal -->
              <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header modealsong">
                      <h5 class="modal-title">Schedule a Pickup</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div>
                        <p>Your Name*</p>
                        <input type="text" name="name" placeholder="Your Name*" required class="form-control my-2"
                          value="{{context.name}}">
                        <p>Phone*</p>
                        <input type="tel" name="phone" placeholder="Your Phone Number" required class="form-control"
                          value="{{context.phone}}">
                        <p>Address*</p>
                        <input type="text" name="address" placeholder="Address*" required class="form-control my-2"
                          value="{{context.address}}">
                        <p>Choose Product*</p>
                        <div id="product-list">
                          {% for pro in product %}
                          {% for item in pro.price_json %}
                          <div class="product-row" data-id="{{ pro.id }}" data-title="{{ pro.title }}"
                            data-service="{{ item|jsonify }}" data-price="{{ item.price }}">
                            <div class="product-name">{{ pro.title }}</div>
                            <div class="quantity-controls">
                              <button type="button" class="decrease">-</button>
                              <span class="quantity">0</span>
                              <button type="button" class="increase">+</button>
                            </div>
                            <div class="product-price">₹{{ item.price }}</div>
                          </div>
                          {% endfor %}
                          {% endfor %}
                        </div>
                        <div class="total">
                          Total: ₹<span id="total-price">0</span>
                        </div>
                        <label class="mt-3">Pickup Date</label>
                        <input type="date" name="pickup_date" id="pickupDate" class="form-control mb-2" required>
                        <label>Pickup Slot</label>
                        <select name="pickup_slot" id="pickupSlot" class="form-select mb-2" required>
                          <option value="">Select Pickup Slot</option>
                        </select>
                        <label>Drop Slot</label>
                        <select name="drop_slot" id="dropSlot" class="form-select mb-2" required>
                          <option value="">Select Drop Slot</option>
                        </select>
                        <input type="hidden" name="selected_items" id="selected-items">
                        <input type="hidden" id="userId" value="{{ context.id }}">
                        <button id="mysubmitbtn" class="btn btn-primary w-100 on">Order
                          Now</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>
    {% block content %}
    {% endblock %}

    <footer class="footerssection">
      <div class="container">
        <div class="borerbootom-footer">
          <div class="row">
            <div class="col-12 col-md-6 col-lg-4 col-xl-4">
              <div class="firstboxsing mt-4">
                <a href="#"><img src="/media/images/footerimges.png" alt="ironissue"></a>
                <p>We are professionals in the laundry and dry cleaning business, which means we always stay up to date
                  on the latest technologies and cleaning methods.</p>
                <div class="whatsapp-boxtitle">
                  <a href="#"><i class="fa-brands fa-whatsapp"></i></a>
                  <a href="#"><i class="fa-brands fa-instagram"></i></a>
                  <a href="#"><i class="fa-brands fa-facebook-f"></i></a>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4 col-xl-4">
              <div class="contact-list mt-4">
                <ul>
                  <li><strong>Contact Info</strong></li>
                  <li><a href="#"><span>+91-9642854965</span></a></li>
                  <li><a href="#">info@yourlaundrysite.com</a></li>
                  <li><a href="#">Lorem Ipsum is simply dummy text of the printing and</a></li>
                </ul>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4 col-xl-4">
              <div class="contact-list mt-4">
                <ul>
                  <li><strong>Newsletter Subscribe</strong></li>
                  <li><a href="#">Sign up and receive our special offers.</a></li>
                  <li><a href="#">Clearing Maintenance</a></li>
                  <li>
                    <form>
                      <input type="email" placeholder="Your e-mail address" />
                      <button type="submit">Subscribe now</button>
                      </ Kukform>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
    </footer>
    <div class="">
      <button onclick="topFunction()" id="topBtn" title="Go to top"><i class="fa-solid fa-arrow-up"></i></button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

  <script>
    const btntoggle = document.getElementById("topBtn");
    window.onscroll = () => btntoggle.style.display = window.scrollY > 200 ? "block" : "none";
    const topFunction = () => window.scrollTo({ top: 0, behavior: "smooth" });
  </script>

  <script>
    $(function () {
      var owl = $(".oarousel");
      owl.owlCarousel({
        items: 4,
        margin: 15,
        loop: true,
        dots: true,
        nav: false,
        autoplay: true,
        responsive: {
          0: { items: 2 },
          600: { items: 2 },
          1000: { items: 4 }
        }
      });
    });
  </script>

  <script>
    $(function () {
      var owl = $(".owl-ssqwq");
      owl.owlCarousel({
        items: 3,
        margin: 0,
        loop: true,
        nav: false,
        dots: true,
        responsive: {
          0: { items: 1 },
          600: { items: 2 },
          1000: { items: 3 }
        }
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const rows = document.querySelectorAll(".product-row");
      const totalPriceEl = document.getElementById("total-price");
      const selectedItemsInput = document.getElementById("selected-items");
      const pickupSlotSelect = document.getElementById("pickupSlot");
      const dropSlotSelect = document.getElementById("dropSlot");
      const pickupDateInput = document.getElementById("pickupDate");
      const submitBtn = document.getElementById("mysubmitbtn"); // Correct ID

      // Populate pickup slots
      const dropSlotMapping = {
        "6:00 AM - 7:00 AM": [
          { from: "4:00 PM", to: "5:00 PM", dayOffset: 0 },
          { from: "7:00 PM", to: "8:00 PM", dayOffset: 0 },
          { from: "6:00 AM", to: "7:00 AM", dayOffset: 1 },
          { from: "9:00 AM", to: "10:00 AM", dayOffset: 1 },
        ],
        "9:00 AM - 10:00 AM": [
          { from: "7:00 PM", to: "8:00 PM", dayOffset: 0 },
          { from: "6:00 AM", to: "7:00 AM", dayOffset: 1 },
          { from: "9:00 AM", to: "10:00 AM", dayOffset: 1 },
          { from: "4:00 PM", to: "5:00 PM", dayOffset: 1 },
        ],
        "4:00 PM - 5:00 PM": [
          { from: "6:00 AM", to: "7:00 AM", dayOffset: 1 },
          { from: "9:00 AM", to: "10:00 AM", dayOffset: 1 },
          { from: "4:00 PM", to: "5:00 PM", dayOffset: 1 },
          { from: "7:00 PM", to: "8:00 PM", dayOffset: 1 },
        ],
        "7:00 PM - 8:00 PM": [
          { from: "9:00 AM", to: "10:00 AM", dayOffset: 1 },
          { from: "4:00 PM", to: "5:00 PM", dayOffset: 1 },
          { from: "7:00 PM", to: "8:00 PM", dayOffset: 1 },
          { from: "6:00 AM", to: "7:00 AM", dayOffset: 2 },
        ],
      };

      Object.keys(dropSlotMapping).forEach((slot) => {
        const option = document.createElement("option");
        option.value = slot;
        option.textContent = slot;
        pickupSlotSelect.appendChild(option);
      });

      function updateDropSlots() {
        const selectedPickupSlot = pickupSlotSelect.value;
        const pickupDate = new Date(pickupDateInput.value);
        dropSlotSelect.innerHTML = '<option value="">Select Drop Slot</option>';

        if (!selectedPickupSlot || isNaN(pickupDate.getTime())) return;

        const dropOptions = dropSlotMapping[selectedPickupSlot];
        dropOptions.forEach(({ from, to, dayOffset }) => {
          const dropDate = new Date(pickupDate);
          dropDate.setDate(dropDate.getDate() + dayOffset);
          const formattedDate = dropDate.toISOString().split("T")[0];
          const label = `${from} - ${to} (${formattedDate})`;

          const option = document.createElement("option");
          option.value = label;
          option.textContent = label;
          dropSlotSelect.appendChild(option);
        });
      }

      pickupSlotSelect.addEventListener("change", updateDropSlots);
      pickupDateInput.addEventListener("change", updateDropSlots);

      function updateTotal() {
        let total = 0;
        rows.forEach((row) => {
          const price = parseFloat(row.dataset.price);
          const qty = parseInt(row.querySelector(".quantity").textContent);
          total += price * qty;
        });
        totalPriceEl.textContent = total.toFixed(2);
      }

      rows.forEach((row) => {
        const increaseBtn = row.querySelector(".increase");
        const decreaseBtn = row.querySelector(".decrease");
        const qtyEl = row.querySelector(".quantity");

        increaseBtn.addEventListener("click", (e) => {
          e.preventDefault();
          qtyEl.textContent = parseInt(qtyEl.textContent) + 1;
          updateTotal();
        });

        decreaseBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const currentQty = parseInt(qtyEl.textContent);
          if (currentQty > 0) {
            qtyEl.textContent = currentQty - 1;
            updateTotal();
          }
        });
      });

      async function submitData() {
        const name = document.querySelector("input[name='name']").value;
        const phone = document.querySelector("input[name='phone']").value;
        const address = document.querySelector("input[name='address']").value;
        const pickupDate = pickupDateInput.value;
        const pickupSlot = pickupSlotSelect.value;
        const dropSlot = dropSlotSelect.value;
        const userId = document.getElementById("userId").value;

        if (!name || !phone || !address || !pickupDate || !pickupSlot || !dropSlot) {
          alert("Please fill in all required fields, including pickup and drop slots.");
          submitBtn.disabled = false;
          return;
        }

        // Collect selected items
        const selectedItems = [];
        let totalAmount = 0;

        rows.forEach((row) => {
          const qty = parseInt(row.querySelector(".quantity").textContent);
          if (qty > 0) {
            const serviceData = row.dataset.service;
            const price = parseFloat(row.dataset.price);
            let serviceObj = {};

            try {
              serviceObj = JSON.parse(serviceData); // Assume data-service is valid JSON
            } catch (err) {
              console.error("Invalid service JSON:", serviceData, err);
              alert("Error processing product data. Please try again.");
              return;
            }

            selectedItems.push({
              product_id: row.dataset.id,
              chosed_service: serviceObj,
              quantity: qty,
            });

            totalAmount += price * qty;
          }
        });

        if (selectedItems.length === 0) {
          alert("Please select at least one product.");
          submitBtn.disabled = false;
          return;
        }

        // Populate hidden input
        selectedItemsInput.value = JSON.stringify(selectedItems);

        // Prepare payload
        const trxId = "txn_" + Date.now();
        const paymentType = "cash";

        const payload = {
          userid: userId,
          trx_id: trxId,
          payment_typ: paymentType,
          product: selectedItems,
          total_booked_amount: totalAmount,
          iroing: false,
          deliverd: false,
          address: address,
          latitude: "28.6448",
          longitude: "77.216721",
          delivery_slot: dropSlot,
          pickup_slot: pickupSlot,
          pickup_date: pickupDate,
        };

        console.log("Payload:", payload);

        try {
          const res = await fetch("/api/create-order", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          if (res.ok) {
            alert("Order placed successfully!");
            // Reset form
            document.querySelector("input[name='name']").value = "";
            document.querySelector("input[name='phone']").value = "";
            document.querySelector("input[name='address']").value = "";
            pickupDateInput.value = "";
            pickupSlotSelect.value = "";
            dropSlotSelect.innerHTML = '<option value="">Select Drop Slot</option>';
            totalPriceEl.textContent = "0";
            rows.forEach((row) => {
              row.querySelector(".quantity").textContent = "0";
            });
          } else {
            console.error("API Error:", data);
            alert("Failed to place order: " + (data.message || "Unknown error"));
          }
        } catch (err) {
          console.error("Network Error:", err);
          alert("Network error! Please check your connection and try again.");
        } finally {
          submitBtn.disabled = false;
        }
      }

      submitBtn.addEventListener("click", () => {
        submitBtn.disabled = true;
        submitData();
      });
    });
  </script>
</body>

</html>